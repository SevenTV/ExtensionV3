<template>
	<div class="emote-box">
		<img
			v-if="srcset"
			ref="imgRef"
			class="chat-emote"
			:srcset="srcset"
			:alt="emote.name"
			:class="{ blur: hideUnlisted && emote.data?.listed === false }"
			@click="openCard"
			@load="onImageLoad"
			@mouseenter="show(imgRef)"
			@mouseleave="hide()"
		/>
		<template v-for="(e, index) of emote.overlaid" :key="index">
			<img
				class="chat-emote zero-width-emote"
				:class="{ blur: hideUnlisted && e.data?.listed === false }"
				:srcset="srcset"
				:alt="' ' + e.name"
			/>
		</template>
	</div>
</template>

<script setup lang="ts">
import { computed, ref } from "vue";
import { imageHostToSrcset } from "@/common/Image";
import { useConfig } from "@/composable/useSettings";
import { useTooltip } from "@/composable/useTooltip";
import { tools } from "@/site/twitch.tv/modules/chat/ChatBackend";
import EmoteTooltip from "@/site/twitch.tv/modules/chat/components/message/EmoteTooltip.vue";

const props = withDefaults(
	defineProps<{
		emote: SevenTV.ActiveEmote;
		imageFormat?: SevenTV.ImageFormat;
		unload?: boolean;
	}>(),
	{ unload: false, imageFormat: "WEBP" },
);

const srcset = computed(() => (props.emote.data ? (props.unload ? "" : imageHostToSrcset(props.emote.data.host)) : ""));

const imgRef = ref<HTMLImageElement>();

const hideUnlisted = useConfig<boolean>("general.blur_unlisted_emotes");

const width = ref(0);
const height = ref(0);
const onImageLoad = (event: Event) => {
	if (!(event.target instanceof HTMLImageElement)) return;

	width.value = event.target.naturalWidth;
	height.value = event.target.naturalHeight;
};

const { show, hide } = useTooltip(EmoteTooltip, {
	emote: props.emote,
	width: width,
	height: height,
});
const openCard = (ev: MouseEvent) => {
	if (!props.emote.id || props.emote.provider !== "TWITCH") return;

	const rect = (ev.target as HTMLElement).getBoundingClientRect();
	tools.emoteClick({
		emoteID: props.emote.id,
		emoteCode: props.emote.name,
		sourceID: "chat",
		initialTopOffset: rect.bottom,
		initialBottomOffset: rect.top,
	});
};
</script>

<style scoped lang="scss">
.emote-box {
	display: grid;
	overflow: clip;
}
img.chat-emote {
	font-weight: 900;
	grid-column: 1;
	grid-row: 1;
	margin: auto;

	&:hover {
		cursor: pointer;
	}
}

img.blur {
	filter: blur(16px);
	overflow: clip;
}

img.zero-width-emote {
	pointer-events: none;
}
</style>
